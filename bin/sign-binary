#!/bin/bash
#
# create-dmg packages the aws-okta CLI binary for macOS
# using Apple's signing and notarizing process
#

set -euo pipefail

notarization_status() {
  /Applications/Xcode.app/Contents/Developer/usr/bin/altool --notarization-info "$1" --username "$APPLE_ID_USERNAME" --password "$APPLE_ID_APP_PASSWORD" 2>&1 \
    | awk -F ': ' '/Status:/ { print $2; }'
}

get_apple_id() {
  op read --account $ONE_PASSWORD_ACCOUNT "op://Parents/Apple/username"
}

get_apple_password() {
  op read --account $ONE_PASSWORD_ACCOUNT "op://Parents/Apple/Developer/App-specific Password"
}

get_cert_id() {
  op read --account $ONE_PASSWORD_ACCOUNT "op://Parents/Apple/Developer/Certificate Id"
}

SOURCE_BIN="$1"
TARGET_BIN="$2"
BIN_NAME="$(basename $TARGET_BIN)"
APPLE_ID_USERNAME="${APPLE_ID_USERNAME:-$(get_apple_id)}"
APPLE_ID_APP_PASSWORD="${APPLE_ID_APP_PASSWORD:-$(get_apple_password)}"
CERT_ID="${CERT_ID:-$(get_cert_id)}"
BUNDLE_ID="${BUNDLE_ID:-"com.ensighten.$BIN_NAME"}"

tmpdir="$(mktemp -d)"
trap "rm -rf $tmpdir" EXIT

src_path="$tmpdir/$BIN_NAME"
dmg_path="$tmpdir/$BIN_NAME.dmg"
cp -a $SOURCE_BIN $src_path

echo "Signing binary"
codesign --options runtime --timestamp --sign "$CERT_ID" --force "$src_path"

echo "Creating dmg"
hdiutil create -quiet -srcfolder "$src_path" "$dmg_path"

echo "Signing dmg"
codesign --timestamp --sign "$CERT_ID" "$dmg_path"

echo "Submitting notorization request"
request_uuid=$(/Applications/Xcode.app/Contents/Developer/usr/bin/altool --notarize-app --primary-bundle-id "$BUNDLE_ID" --username "$APPLE_ID_USERNAME" --password "$APPLE_ID_APP_PASSWORD" --file "$dmg_path" 2>&1 \
  | awk '/RequestUUID/ { print $NF; }')
echo "Finished submitting, got Request UUID $request_uuid"

echo -n "Waiting for notorization to complete"
while [[ "$(notarization_status "$request_uuid")" == "in progress" ]] ; do
  echo -n .
  sleep 10
done
echo

status="$(notarization_status "$request_uuid")"
if [[ "$status" != "success" ]] ; then
  echo "Notorization status is: $status"
  exit 1
fi

hdiutil attach "$dmg_path"
mkdir -p "$(dirname $TARGET_BIN)"
cp -r -f "/Volumes/$BIN_NAME/$BIN_NAME" "$TARGET_BIN"
hdiutil detach "/Volumes/$BIN_NAME"
chmod 755 "$TARGET_BIN"
